<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Connector Inventory Search</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    * { box-sizing: border-box; }

    html, body {
      height: 100%;
    }

    body {
      margin: 0;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background: radial-gradient(circle at top left, #e0edff 0, #f5f7fb 45%, #ffffff 100%);
      color: #0f172a;
      display: flex;
    }

    .page {
      max-width: 1100px;
      margin: 24px auto;
      padding: 0 16px;
      flex: 1;
      min-height: 100vh;
      display: flex;
    }

    .card {
      background: rgba(255, 255, 255, 0.98);
      border-radius: 18px;
      border: 1px solid rgba(148, 163, 184, 0.4);
      box-shadow: 0 18px 45px rgba(15, 23, 42, 0.12);
      padding: 16px 20px;
      flex: 1;
      display: flex;
      flex-direction: column;
      min-height: 0;
    }

    .card-header {
      display: flex;
      justify-content: space-between;
      align-items: baseline;
      gap: 12px;
      margin-bottom: 12px;
      flex: 0 0 auto;
    }

    .card-header h1 {
      font-size: 1.35rem;
      margin: 0;
      letter-spacing: 0.03em;
    }

    .card-header span {
      font-size: 0.78rem;
      color: #6b7280;
      text-transform: uppercase;
      letter-spacing: 0.08em;
    }

    /* Filters layout */
    .search-row {
      display: grid;
      grid-template-columns: minmax(0, 2.2fr) repeat(4, minmax(0, 1fr));
      gap: 10px;
      margin-bottom: 8px;
      flex: 0 0 auto;
    }
    .search-row.secondary {
      grid-template-columns: repeat(3, minmax(0, 1fr));
      margin-bottom: 10px;
      gap: 10px;
    }

    @media (max-width: 900px) {
      .search-row,
      .search-row.secondary {
        grid-template-columns: minmax(0, 1fr);
      }
    }

    .field {
      display: flex;
      flex-direction: column;
      gap: 4px;
      font-size: 0.8rem;
      position: relative;
    }

    .field label {
      font-weight: 500;
      color: #4b5563;
    }

    .field input {
      border-radius: 999px;
      border: 1px solid #cbd5e1;
      padding: 6px 10px;
      font-size: 0.85rem;
      outline: none;
      background: #f9fafb;
      transition: border-color .15s ease, box-shadow .15s ease, background .15s ease;
    }

    .field input:focus {
      border-color: #2563eb;
      background: #ffffff;
      box-shadow: 0 0 0 1px rgba(37, 99, 235, 0.3);
    }

    .search-wrapper { position: relative; }
    .search-wrapper input { padding-right: 26px; }

    .clear-btn {
      position: absolute;
      right: 8px;
      top: 50%;
      transform: translateY(-50%);
      border: none;
      background: transparent;
      font-size: 14px;
      cursor: pointer;
      color: #9ca3af;
      padding: 0;
      line-height: 1;
    }

    .clear-btn:hover { color: #6b7280; }

    /* Custom multi-select "fake dropdown" */
    .multi-select {
      border-radius: 999px;
      border: 1px solid #cbd5e1;
      padding: 6px 10px;
      font-size: 0.85rem;
      background: #f9fafb;
      display: flex;
      justify-content: space-between;
      align-items: center;
      cursor: pointer;
      transition: border-color .15s ease, box-shadow .15s ease, background .15s ease;
    }

    .multi-select.open {
      border-color: #2563eb;
      background: #ffffff;
      box-shadow: 0 0 0 1px rgba(37, 99, 235, 0.3);
    }

    .multi-select.active {
      border-color: #2563eb;
      background: #eff6ff;
    }

    .multi-select-label {
      color: #111827;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      max-width: 100%;
      font-size: 0.8rem;
    }

    .multi-select-placeholder {
      color: #9ca3af;
    }

    .multi-select-caret {
      margin-left: 6px;
      font-size: 0.7rem;
      color: #6b7280;
    }

    .multi-select-menu {
      position: absolute;
      left: 0;
      right: 0;
      top: 100%;
      margin-top: 4px;
      z-index: 10;
      background: #ffffff;
      border-radius: 12px;
      border: 1px solid #e5e7eb;
      box-shadow: 0 14px 35px rgba(15, 23, 42, 0.18);
      max-height: 260px;
      overflow-y: auto;
      padding: 0;
      display: none;
    }

    .multi-select-menu.open {
      display: block;
    }

    .multi-select-menu-header {
      padding: 4px 10px;
      border-bottom: 1px solid #e5e7eb;
      display: flex;
      justify-content: flex-end;
      background: #f9fafb;
      position: sticky;
      top: 0;
      z-index: 1;
    }

    .multi-select-clear {
      border: none;
      background: none;
      font-size: 0.75rem;
      color: #2563eb;
      cursor: pointer;
      text-decoration: underline;
      padding: 0;
    }

    .multi-select-menu label {
      display: flex;
      align-items: center;
      gap: 6px;
      padding: 4px 10px;
      font-size: 0.8rem;
      cursor: pointer;
      white-space: nowrap;
    }

    .multi-select-menu label:hover {
      background: #eff6ff;
    }

    .multi-select-menu input[type="checkbox"] {
      width: 13px;
      height: 13px;
      cursor: pointer;
    }

    .toolbar {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin: 4px 0 6px;
      font-size: 0.8rem;
      color: #6b7280;
      gap: 10px;
      flex-wrap: wrap;
      flex: 0 0 auto;
    }

    .toolbar-right {
      display: flex;
      align-items: center;
      gap: 10px;
      flex-wrap: wrap;
    }

    .toolbar button {
      border-radius: 999px;
      border: none;
      padding: 5px 12px;
      font-size: 0.8rem;
      cursor: pointer;
      background: #0f172a;
      color: #f9fafb;
      display: inline-flex;
      align-items: center;
      gap: 6px;
      box-shadow: 0 8px 18px rgba(15, 23, 42, 0.25);
      transition: transform .12s ease, box-shadow .12s ease, background .12s ease;
    }

    .toolbar button:hover {
      background: #111827;
      transform: translateY(-1px);
      box-shadow: 0 12px 24px rgba(15, 23, 42, 0.3);
    }

    .pager {
      display: flex;
      justify-content: flex-end;
      align-items: center;
      gap: 8px;
      margin: 4px 0 8px;
      font-size: 0.78rem;
      color: #4b5563;
    }

    .pager button {
      border-radius: 999px;
      border: 1px solid #cbd5e1;
      padding: 3px 10px;
      font-size: 0.78rem;
      background: #ffffff;
      cursor: pointer;
    }

    .pager button:disabled {
      opacity: 0.4;
      cursor: default;
    }

    .tiny-check {
      display: inline-flex;
      align-items: center;
      gap: 4px;
      font-size: 0.75rem;
      color: #4b5563;
      white-space: nowrap;
    }

    .tiny-check input {
      width: 12px;
      height: 12px;
      margin: 0;
    }

    /* Action bar below toolbar */
    .action-bar {
      display: none;
      align-items: center;
      justify-content: space-between;
      gap: 10px;
      padding: 6px 10px;
      margin-bottom: 8px;
      border-radius: 999px;
      background: #eff6ff;
      font-size: 0.8rem;
      flex: 0 0 auto;
    }

    .action-selected {
      font-weight: 500;
      color: #1f2937;
    }

    .action-selected span {
      font-weight: 600;
    }

    .action-controls {
      display: flex;
      align-items: center;
      gap: 8px;
      flex-wrap: wrap;
    }

    .action-controls label {
      font-weight: 500;
      color: #4b5563;
    }

    .action-controls select {
      border-radius: 999px;
      border: 1px solid #cbd5e1;
      padding: 4px 10px;
      font-size: 0.8rem;
      background: #ffffff;
    }

    .action-controls button {
      border-radius: 999px;
      border: none;
      padding: 4px 12px;
      font-size: 0.8rem;
      cursor: pointer;
      background: #2563eb;
      color: #f9fafb;
    }

    .action-controls button:hover {
      background: #1d4ed8;
    }

    .action-status {
      min-width: 140px;
      font-size: 0.78rem;
      color: #4b5563;
    }

    /* TABLE AREA */
    .table-wrapper {
      border-radius: 12px;
      border: 1px solid #e5e7eb;
      overflow: hidden;
      background: #ffffff;
      flex: 1 1 auto;
      min-height: 0;
      overflow-y: auto;
      overflow-x: hidden;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      font-size: 0.78rem;
      table-layout: fixed;
    }

    thead {
      background: #f3f4f6;
      position: sticky;
      top: 0;
      z-index: 1;
    }

    th, td {
      padding: 6px 6px;
      border-bottom: 1px solid #e5e7eb;
      text-align: center;
      vertical-align: middle;
      white-space: normal;
      overflow: hidden;
      word-wrap: break-word;
      word-break: break-word;
    }

    th {
      font-weight: 600;
      color: #4b5563;
      user-select: none;
    }

    th.sortable { cursor: pointer; }
    th.sortable:hover { background: #e5e7eb; }

    tbody tr:nth-child(even):not(.details-row) { background: #f9fafb; }
    tbody tr:hover:not(.details-row):not(.selected-row) { background: #e0f2fe; }

    .data-row.selected-row {
      background: #dbeafe !important;
      outline: 1px solid #2563eb;
    }

    .tag {
      display: inline-flex;
      align-items: center;
      border-radius: 999px;
      border: 1px solid #d1d5db;
      padding: 1px 6px;
      font-size: 0.68rem;
      text-transform: uppercase;
      letter-spacing: 0.06em;
      background: #f9fafb;
    }

    .qty-pill {
      border-radius: 999px;
      padding: 1px 8px;
      font-size: 0.7rem;
      font-variant-numeric: tabular-nums;
      display: inline-block;
    }

    .qty-ok { background: #ecfdf5; color: #047857; }
    .qty-low { background: #fffbeb; color: #92400e; }
    .qty-zero { background: #fef2f2; color: #b91c1c; }

    .muted {
      color: #9ca3af;
      font-style: italic;
    }

    .thumb-img {
      width: 100%;
      max-width: 200px;
      height: 120px;
      border-radius: 10px;
      cursor: pointer;
      object-fit: contain;
      background: #e5e7eb;
      display: block;
      margin: 0 auto;
    }

    .expander {
      cursor: pointer;
      font-size: 0.9rem;
      user-select: none;
      padding-right: 2px;
    }

    .details-row { background: #f9fafb; }

    .details-cell {
      padding-top: 0;
      padding-bottom: 8px;
    }

    .details-grid {
      margin-top: 4px;
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(170px, 1fr));
      gap: 4px 12px;
      font-size: 0.75rem;
    }

    .details-term-block {
      border-radius: 10px;
      background: #f3f4f6;
      padding: 6px 8px;
    }

    .details-term-title {
      font-size: 0.75rem;
      font-weight: 600;
      color: #4b5563;
      text-transform: uppercase;
      letter-spacing: 0.06em;
      margin-bottom: 2px;
    }

    .details-term-main {
      font-size: 0.8rem;
      font-weight: 600;
      color: #111827;
      margin-bottom: 2px;
    }

    .details-term-sub {
      font-size: 0.75rem;
      color: #4b5563;
    }

    thead th:nth-child(1),
    tbody td:nth-child(1) { width: 24px; max-width: 24px; }   /* expander */
    thead th:nth-child(2),
    tbody td:nth-child(2) { width: 215px; max-width: 215px; } /* Pic */
    thead th:nth-child(3),
    tbody td:nth-child(3) { width: 120px; max-width: 120px; } /* Part # */
    thead th:nth-child(4),
    tbody td:nth-child(4) { width: 120px; max-width: 120px; } /* Desc */
    thead th:nth-child(5),
    tbody td:nth-child(5) { width: 60px; max-width: 60px; }   /* Shop */
    thead th:nth-child(6),
    tbody td:nth-child(6) { width: 40px; max-width: 40px; }   /* Shop Qty */
    thead th:nth-child(7),
    tbody td:nth-child(7) { width: 100px; max-width: 100px; } /* Van */
    thead th:nth-child(8),
    tbody td:nth-child(8) { width: 40px; max-width: 40px; }   /* Van Qty */
    thead th:nth-child(9),
    tbody td:nth-child(9) { width: 40px; max-width: 40px; }   /* Pins */
    thead th:nth-child(10),
    tbody td:nth-child(10) { width: 110px; max-width: 110px; }/* Type */
    thead th:nth-child(11),
    tbody td:nth-child(11) { width: 35px; max-width: 35px; }  /* M/F */
    thead th:nth-child(12),
    tbody td:nth-child(12) { width: 85px; max-width: 85px; }  /* Supplier */
  </style>
</head>
<body>
  <div class="page">
    <div class="card">
      <div class="card-header">
        <div>
          <h1>Connector Inventory</h1>
          <span>Search · Filter · Locate</span>
        </div>
        <div style="font-size:0.8rem; color:#6b7280;">OnsitePASS · Internal</div>
      </div>

      <!-- Primary filters -->
      <div class="search-row">
        <div class="field">
          <label for="searchInput">Search</label>
          <div class="search-wrapper">
            <input id="searchInput" type="text" placeholder="Part #, description, alt #, notes…" />
            <button type="button" class="clear-btn" id="clearSearchBtn">&times;</button>
          </div>
        </div>

        <!-- Type / Category multi-select (Col N) -->
        <div class="field" data-filter="category">
          <label>Type (Col N)</label>
          <div class="multi-select" data-filter-toggle="category">
            <span class="multi-select-label multi-select-placeholder" id="categoryLabel">All</span>
            <span class="multi-select-caret">▾</span>
          </div>
          <div class="multi-select-menu" data-filter-menu="category">
            <div class="multi-select-menu-header">
              <button type="button" class="multi-select-clear" data-clear="category">Clear</button>
            </div>
            <label><input type="checkbox" value="connector"> Connector</label>
            <label><input type="checkbox" value="terminal"> Terminal</label>
            <label><input type="checkbox" value="accessory"> Accessory</label>
          </div>
        </div>

        <!-- Pins multi-select (Stats!A2:A → Col M) -->
        <div class="field" data-filter="pins">
          <label>Pin Count (Stats!A2:A → Col M)</label>
          <div class="multi-select" data-filter-toggle="pins">
            <span class="multi-select-label multi-select-placeholder" id="pinsLabel">Any</span>
            <span class="multi-select-caret">▾</span>
          </div>
          <div class="multi-select-menu" data-filter-menu="pins">
            <div class="multi-select-menu-header">
              <button type="button" class="multi-select-clear" data-clear="pins">Clear</button>
            </div>
            <!-- options added dynamically -->
          </div>
        </div>

        <!-- Gender multi-select (Col L) -->
        <div class="field" data-filter="gender">
          <label>Gender (Col L)</label>
          <div class="multi-select" data-filter-toggle="gender">
            <span class="multi-select-label multi-select-placeholder" id="genderLabel">Any</span>
            <span class="multi-select-caret">▾</span>
          </div>
          <div class="multi-select-menu" data-filter-menu="gender">
            <div class="multi-select-menu-header">
              <button type="button" class="multi-select-clear" data-clear="gender">Clear</button>
            </div>
            <label><input type="checkbox" value="male"> Male</label>
            <label><input type="checkbox" value="female"> Female</label>
            <label><input type="checkbox" value="m & f"> M & F</label>
          </div>
        </div>

        <!-- Terminal size multi-select (Col AP) -->
        <div class="field" data-filter="termSize">
          <label>Terminal Size (Col AP)</label>
          <div class="multi-select" data-filter-toggle="termSize">
            <span class="multi-select-label multi-select-placeholder" id="termSizeLabel">Any</span>
            <span class="multi-select-caret">▾</span>
          </div>
          <div class="multi-select-menu" data-filter-menu="termSize">
            <div class="multi-select-menu-header">
              <button type="button" class="multi-select-clear" data-clear="termSize">Clear</button>
            </div>
            <label><input type="checkbox" value="0.25"> 0.25</label>
            <label><input type="checkbox" value="0.5"> 0.5</label>
            <label><input type="checkbox" value="0.63"> 0.63</label>
            <label><input type="checkbox" value="0.64"> 0.64</label>
            <label><input type="checkbox" value="1.0"> 1.0</label>
            <label><input type="checkbox" value="1.2"> 1.2</label>
            <label><input type="checkbox" value="1.3"> 1.3</label>
            <label><input type="checkbox" value="1.5"> 1.5</label>
            <label><input type="checkbox" value="1.6"> 1.6</label>
            <label><input type="checkbox" value="1.8"> 1.8</label>
            <label><input type="checkbox" value="2.2"> 2.2</label>
            <label><input type="checkbox" value="2.3"> 2.3</label>
            <label><input type="checkbox" value="2.5"> 2.5</label>
            <label><input type="checkbox" value="2.6"> 2.6</label>
            <label><input type="checkbox" value="2.8"> 2.8</label>
            <label><input type="checkbox" value="4.8"> 4.8</label>
            <label><input type="checkbox" value="6.3"> 6.3</label>
            <label><input type="checkbox" value="7.8"> 7.8</label>
            <label><input type="checkbox" value="8.0"> 8.0</label>
            <label><input type="checkbox" value="9.5"> 9.5</label>
            <label><input type="checkbox" value="12.0"> 12.0</label>
          </div>
        </div>
      </div>

      <!-- Secondary filters -->
      <div class="search-row secondary">
        <div class="field">
          <label for="locationFilter">Location (Shop or Van)</label>
          <input id="locationFilter" type="text" placeholder="Tub27, Van Bin, etc." />
        </div>

        <!-- Manufacturer multi-select -->
        <div class="field" data-filter="manufacturer">
          <label>Supplier (Stats!E2:E → Col Q)</label>
          <div class="multi-select" data-filter-toggle="manufacturer">
            <span class="multi-select-label multi-select-placeholder" id="manufacturerLabel">All</span>
            <span class="multi-select-caret">▾</span>
          </div>
          <div class="multi-select-menu" data-filter-menu="manufacturer">
            <div class="multi-select-menu-header">
              <button type="button" class="multi-select-clear" data-clear="manufacturer">Clear</button>
            </div>
            <!-- dynamically filled -->
          </div>
        </div>

        <!-- OEM/Vehicle multi-select -->
        <div class="field" data-filter="oem">
          <label>Vehicle / OEM</label>
          <div class="multi-select" data-filter-toggle="oem">
            <span class="multi-select-label multi-select-placeholder" id="oemLabel">Any</span>
            <span class="multi-select-caret">▾</span>
          </div>
          <div class="multi-select-menu" data-filter-menu="oem">
            <div class="multi-select-menu-header">
              <button type="button" class="multi-select-clear" data-clear="oem">Clear</button>
            </div>
            <label><input type="checkbox" value="Ford"> Ford</label>
            <label><input type="checkbox" value="GM"> GM</label>
            <label><input type="checkbox" value="HyundaiKia"> Hyundai/Kia</label>
            <label><input type="checkbox" value="Nissan"> Nissan</label>
            <label><input type="checkbox" value="Toyota"> Toyota</label>
          </div>
        </div>
      </div>

      <div class="toolbar">
        <div id="resultsCount">Loading inventory…</div>
        <div class="toolbar-right">
          <label class="tiny-check">
            <input type="checkbox" id="hasPictureFilter" /> Pic only
          </label>
          <button type="button" id="resetFiltersBtn"><span>↺</span> Reset filters</button>
        </div>
      </div>

      <!-- Action bar: selection + actions -->
      <div id="actionBar" class="action-bar">
        <div class="action-selected">
          Selected: <span id="selectedPart">(none)</span>
        </div>
        <div class="action-controls">
          <label for="actionSelect">Action</label>
          <select id="actionSelect">
            <option value="">Choose…</option>
            <option value="request">Request this connector</option>
          </select>
          <button type="button" id="runActionBtn">Go</button>
          <span id="actionStatus" class="action-status"></span>
        </div>
      </div>

      <!-- Pager -->
      <div id="pager" class="pager">
        <button type="button" id="prevPageBtn">‹ Prev</button>
        <span id="pageInfo">Page 1 of 1 · 0 items</span>
        <button type="button" id="nextPageBtn">Next ›</button>
      </div>

      <!-- Table -->
      <div class="table-wrapper">
        <table>
          <thead>
            <tr>
              <th></th>
              <th>Pic</th>
              <th class="sortable" data-sort="partNumber">Part #</th>
              <th>Description</th>
              <th>Shop</th>
              <th>Qty</th>
              <th>Van</th>
              <th>Qty</th>
              <th class="sortable" data-sort="pins">Pins</th>
              <th>Type</th>
              <th>M/F</th>
              <th>Supplier</th>
            </tr>
          </thead>
          <tbody id="resultsBody">
            <tr><td colspan="12" class="muted">Loading…</td></tr>
          </tbody>
        </table>
      </div>
    </div>
  </div>

  <script>
    const DATA_URL = "/.netlify/functions/get-connectors";
    const REQUEST_URL =
      "https://script.google.com/macros/s/AKfycbzQISzKogNh6a9h3x4Ei6nVK2hYRQkUJNpra0YTY4KcrPDeamps-4rAm67NhMId_DAj/exec";
    const STORAGE_KEY = "connectorInventoryFiltersV1";

    const PAGE_SIZE = 50;
    let currentPage = 1;
    let lastTotalPages = 1;

    let connectorData = [];
    let currentSort = { key: "partNumber", dir: "asc" };
    let selectedItem = null;
    let openDetailsRow = null;
    let openExpander = null;

    const searchInput = document.getElementById("searchInput");
    const clearSearchBtn = document.getElementById("clearSearchBtn");
    const locationFilter = document.getElementById("locationFilter");
    const resultsBody = document.getElementById("resultsBody");
    const resultsCount = document.getElementById("resultsCount");
    const resetFiltersBtn = document.getElementById("resetFiltersBtn");
    const hasPictureCheckbox = document.getElementById("hasPictureFilter");

    const actionBar = document.getElementById("actionBar");
    const selectedPartSpan = document.getElementById("selectedPart");
    const actionSelect = document.getElementById("actionSelect");
    const runActionBtn = document.getElementById("runActionBtn");
    const actionStatus = document.getElementById("actionStatus");

    const categoryLabel = document.getElementById("categoryLabel");
    const pinsLabel = document.getElementById("pinsLabel");
    const genderLabel = document.getElementById("genderLabel");
    const termSizeLabel = document.getElementById("termSizeLabel");
    const manufacturerLabel = document.getElementById("manufacturerLabel");
    const oemLabel = document.getElementById("oemLabel");

    const prevPageBtn = document.getElementById("prevPageBtn");
    const nextPageBtn = document.getElementById("nextPageBtn");
    const pageInfo = document.getElementById("pageInfo");

    const multiState = {
      category: new Set(),
      pins: new Set(),
      gender: new Set(),
      termSize: new Set(),
      manufacturer: new Set(),
      oem: new Set(),
    };

    function qtyClass(qty) {
      if (qty <= 0) return "qty-zero";
      if (qty <= 3) return "qty-low";
      return "qty-ok";
    }

    function normalize(str) {
      return String(str || "").toLowerCase().replace(/\s+/g, " ").trim();
    }

    function normalizeGenderValue(raw) {
      const v = normalize(raw);
      if (!v) return "";
      if (v.includes("m & f")) return "m & f";
      if (v.includes("m") && v.includes("f") && !v.includes("male") && !v.includes("female"))
        return "m & f";
      if (v.startsWith("m")) return "male";
      if (v.startsWith("f")) return "female";
      return v;
    }

    function updateMultiLabel(filterName) {
      const set = multiState[filterName];
      let labelEl;
      let placeholderText;

      switch (filterName) {
        case "category":
          labelEl = categoryLabel;
          placeholderText = "All";
          break;
        case "pins":
          labelEl = pinsLabel;
          placeholderText = "Any";
          break;
        case "gender":
          labelEl = genderLabel;
          placeholderText = "Any";
          break;
        case "termSize":
          labelEl = termSizeLabel;
          placeholderText = "Any";
          break;
        case "manufacturer":
          labelEl = manufacturerLabel;
          placeholderText = "All";
          break;
        case "oem":
          labelEl = oemLabel;
          placeholderText = "Any";
          break;
      }

      const toggle = document.querySelector(
        `.multi-select[data-filter-toggle="${filterName}"]`
      );
      if (!labelEl || !toggle) return;

      if (!set.size) {
        labelEl.textContent = placeholderText;
        labelEl.classList.add("multi-select-placeholder");
        toggle.classList.remove("active");
      } else if (set.size === 1) {
        const val = Array.from(set)[0];
        labelEl.textContent = val;
        labelEl.classList.remove("multi-select-placeholder");
        toggle.classList.add("active");
      } else {
        labelEl.textContent = `${set.size} selected`;
        labelEl.classList.remove("multi-select-placeholder");
        toggle.classList.add("active");
      }
    }

    function saveFilters() {
      try {
        const state = {
          search: searchInput.value || "",
          location: locationFilter.value || "",
          multi: {
            category: Array.from(multiState.category),
            pins: Array.from(multiState.pins),
            gender: Array.from(multiState.gender),
            termSize: Array.from(multiState.termSize),
            manufacturer: Array.from(multiState.manufacturer),
            oem: Array.from(multiState.oem),
          },
          hasPicture: hasPictureCheckbox.checked,
        };
        localStorage.setItem(STORAGE_KEY, JSON.stringify(state));
      } catch (e) {
        // ignore
      }
    }

    function updatePager(page, totalPages, totalCount) {
      pageInfo.textContent = `Page ${page} of ${totalPages} · ${totalCount} item${
        totalCount === 1 ? "" : "s"
      }`;
      prevPageBtn.disabled = page <= 1;
      nextPageBtn.disabled = page >= totalPages;
      lastTotalPages = totalPages;
    }

    function applyFilters() {
      const search = normalize(searchInput.value);
      const loc = normalize(locationFilter.value);

      const catsSelected = Array.from(multiState.category).map(normalize);
      const pinsSelected = Array.from(multiState.pins).map((v) => String(v));
      const gendersSelected = Array.from(multiState.gender).map(normalizeGenderValue);
      const termSizesSelected = Array.from(multiState.termSize).map(String);
      const mfrSelected = Array.from(multiState.manufacturer).map(normalize);
      const oemSelected = Array.from(multiState.oem).map(normalize);
      const hasPic = hasPictureCheckbox.checked;

      let filtered = connectorData.filter((item) => {
        if (search) {
          const haystack = normalize(
            [
              item.partNumber,
              item.description,
              item.vehicle,
              item.shop,
              item.van,
              item.manufacturer,
              item.gender,
              item.terminalSizes,
            ].join(" ")
          );
          if (!haystack.includes(search)) return false;
        }

        if (catsSelected.length) {
          const catNorm = normalize(item.category);
          if (!catsSelected.includes(catNorm)) return false;
        }

        if (pinsSelected.length) {
          const pinsStr = String(item.pins ?? "");
          if (!pinsSelected.includes(pinsStr)) return false;
        }

        if (gendersSelected.length) {
          const gNorm = normalizeGenderValue(item.gender);
          if (!gendersSelected.includes(gNorm)) return false;
        }

        if (termSizesSelected.length) {
          const raw = String(item.terminalSizes || "");
          const tokens = raw
            .split(/[,/]/)
            .join(" ")
            .split(/\s+/)
            .filter(Boolean);
          if (!tokens.some((t) => termSizesSelected.includes(t))) return false;
        }

        if (loc) {
          const combinedLoc = normalize((item.shop || "") + " " + (item.van || ""));
          if (!combinedLoc.includes(loc)) return false;
        }

        if (mfrSelected.length) {
          const mfNorm = normalize(item.manufacturer);
          if (!mfrSelected.includes(mfNorm)) return false;
        }

        if (oemSelected.length) {
          const itemOems = (item.oems || []).map((o) => normalize(o));
          if (!oemSelected.some((sel) => itemOems.includes(sel))) return false;
        }

        if (hasPic) {
          if (!(item.picture && /^https?:\/\//.test(item.picture))) return false;
        }

        return true;
      });

      filtered.sort((a, b) => {
        const { key, dir } = currentSort;
        let va = a[key],
          vb = b[key];

        if (key === "pins") {
          va = Number(va) || 0;
          vb = Number(vb) || 0;
        } else {
          va = String(va || "").toLowerCase();
          vb = String(vb || "").toLowerCase();
        }

        if (va < vb) return dir === "asc" ? -1 : 1;
        if (va > vb) return dir === "asc" ? 1 : -1;
        return 0;
      });

      const totalCount = filtered.length;
      const totalPages = Math.max(1, Math.ceil(totalCount / PAGE_SIZE));
      if (currentPage > totalPages) currentPage = totalPages;

      const start = (currentPage - 1) * PAGE_SIZE;
      const pageItems = filtered.slice(start, start + PAGE_SIZE);

      renderResults(pageItems, totalCount);
      updatePager(currentPage, totalPages, totalCount);
      saveFilters();
    }

    function createDetailsGrid(details) {
      const grid = document.createElement("div");
      grid.className = "details-grid";

      const makeBlock = (title, main, sub) => {
        if (!main && !sub) return null;
        const block = document.createElement("div");
        block.className = "details-term-block";

        const titleEl = document.createElement("div");
        titleEl.className = "details-term-title";
        titleEl.textContent = title;

        const mainEl = document.createElement("div");
        mainEl.className = "details-term-main";
        mainEl.textContent = main || "";

        const subEl = document.createElement("div");
        subEl.className = "details-term-sub";
        subEl.textContent = sub || "";

        block.appendChild(titleEl);
        if (main) block.appendChild(mainEl);
        if (sub) block.appendChild(subEl);

        return block;
      };

      // Terminal 1: code from Col Y; sub: W (tub) + X (bin/range)
      const t1SubParts = [];
      if (details.terminal1Tub) t1SubParts.push(details.terminal1Tub);
      if (details.terminal1Range) t1SubParts.push(details.terminal1Range);
      const t1Sub = t1SubParts.join("   ");

      const t1 = makeBlock(
        "TERMINAL 1",
        details.terminal1Code,
        t1Sub
      );

      // Terminal 2: code from Col AB; sub: AD (tub) + AC (bin/range)
      const t2SubParts = [];
      if (details.terminal2Tub) t2SubParts.push(details.terminal2Tub);
      if (details.terminal2Range) t2SubParts.push(details.terminal2Range);
      const t2Sub = t2SubParts.join("   ");

      const t2 = makeBlock(
        "TERMINAL 2",
        details.terminal2Code,
        t2Sub
      );

      // Mating
      const mating = makeBlock("MATING", details.mating || "", "");

      // Price
      let priceText = "";
      if (typeof details.price === "number") {
        priceText = `$${details.price.toFixed(2)}`;
      } else if (details.price) {
        priceText = String(details.price);
      }
      const price = makeBlock("PRICE", priceText, "");

      [t1, t2, mating, price].forEach((b) => b && grid.appendChild(b));

      // OEM row
      const ford = makeBlock("FORD", details.ford || "", "");
      const gm = makeBlock("GM", details.gm || "", "");
      const hk = makeBlock("HYUNDAI/KIA", details.hyundaiKia || "", "");
      const nissan = makeBlock("NISSAN", details.nissan || "", "");
      const toyota = makeBlock("TOYOTA", details.toyota || "", "");

      [ford, gm, hk, nissan, toyota].forEach((b) => b && grid.appendChild(b));

      if (!grid.children.length) {
        const empty = document.createElement("div");
        empty.className = "details-item-value";
        empty.textContent = "No extra details.";
        grid.appendChild(empty);
      }

      return grid;
    }

    function selectItem(item, rowEl) {
      selectedItem = item;
      selectedPartSpan.textContent = item.partNumber || "(no part #)";
      actionBar.style.display = "flex";
      actionStatus.textContent = "";

      document.querySelectorAll(".data-row.selected-row").forEach((r) => {
        r.classList.remove("selected-row");
      });
      if (rowEl) rowEl.classList.add("selected-row");
    }

    function renderResults(data, totalCount) {
      resultsBody.innerHTML = "";

      if (!data.length) {
        const row = document.createElement("tr");
        const cell = document.createElement("td");
        cell.colSpan = 12;
        cell.className = "muted";
        cell.textContent = "No matching connectors.";
        row.appendChild(cell);
        resultsBody.appendChild(row);
        resultsCount.textContent = "Showing 0 items";
        return;
      }

      data.forEach((item) => {
        const tr = document.createElement("tr");
        tr.className = "data-row";

        const tdExp = document.createElement("td");
        const exp = document.createElement("span");
        exp.className = "expander";
        exp.textContent = "▸";
        tdExp.appendChild(exp);
        tr.appendChild(tdExp);

        const tdPic = document.createElement("td");
        if (item.picture && /^https?:\/\//.test(item.picture)) {
          const img = document.createElement("img");
          img.src = item.picture;
          img.alt = item.partNumber || "Connector";
          img.className = "thumb-img";
          img.addEventListener("click", (e) => {
            e.stopPropagation();
            window.open(item.picture, "_blank");
          });
          tdPic.appendChild(img);
        } else {
          tdPic.innerHTML = '<span class="muted">—</span>';
        }
        tr.appendChild(tdPic);

        const tdPart = document.createElement("td");
        tdPart.textContent = item.partNumber || "";
        tr.appendChild(tdPart);

        const tdDesc = document.createElement("td");
        tdDesc.textContent = item.description || "";
        tr.appendChild(tdDesc);

        const tdShop = document.createElement("td");
        tdShop.textContent = item.shop || "";
        tr.appendChild(tdShop);

        const tdShopQty = document.createElement("td");
        const shopPill = document.createElement("span");
        shopPill.className = `qty-pill ${qtyClass(item.shopQty)}`;
        shopPill.textContent = item.shopQty;
        tdShopQty.appendChild(shopPill);
        tr.appendChild(tdShopQty);

        const tdVan = document.createElement("td");
        tdVan.textContent = item.van || "";
        tr.appendChild(tdVan);

        const tdVanQty = document.createElement("td");
        const vanPill = document.createElement("span");
        const vanQty = item.vanQty;
        vanPill.className = `qty-pill ${qtyClass(vanQty)}`;
        vanPill.textContent = vanQty;
        tdVanQty.appendChild(vanPill);
        tr.appendChild(tdVanQty);

        const tdPins = document.createElement("td");
        tdPins.textContent = item.pins || "";
        tr.appendChild(tdPins);

        const tdType = document.createElement("td");
        const tag = document.createElement("span");
        tag.className = "tag";
        tag.textContent = item.category || "N/A";
        tdType.appendChild(tag);
        tr.appendChild(tdType);

        const tdGender = document.createElement("td");
        const gNorm = normalizeGenderValue(item.gender);
        tdGender.textContent =
          gNorm === "female" ? "F" : gNorm === "male" ? "M" : gNorm.toUpperCase();
        tr.appendChild(tdGender);

        const tdMfr = document.createElement("td");
        tdMfr.textContent = item.manufacturer || "";
        tr.appendChild(tdMfr);

        const detailsTr = document.createElement("tr");
        detailsTr.className = "details-row";
        detailsTr.style.display = "none";

        const detailsTd = document.createElement("td");
        detailsTd.colSpan = 12;
        detailsTd.className = "details-cell";

        const detailsGrid = createDetailsGrid(item.details || {});
        detailsTd.appendChild(detailsGrid);
        detailsTr.appendChild(detailsTd);

        const toggle = () => {
          const isOpen = detailsTr.style.display !== "none";
          if (!isOpen) {
            if (openDetailsRow && openDetailsRow !== detailsTr) {
              openDetailsRow.style.display = "none";
            }
            if (openExpander && openExpander !== exp) {
              openExpander.textContent = "▸";
            }
            detailsTr.style.display = "";
            exp.textContent = "▾";
            openDetailsRow = detailsTr;
            openExpander = exp;
          } else {
            detailsTr.style.display = "none";
            exp.textContent = "▸";
            openDetailsRow = null;
            openExpander = null;
          }
        };

        exp.addEventListener("click", (e) => {
          e.stopPropagation();
          toggle();
          selectItem(item, tr);
        });

        tr.addEventListener("click", () => {
          toggle();
          selectItem(item, tr);
        });

        resultsBody.appendChild(tr);
        resultsBody.appendChild(detailsTr);
      });

      resultsCount.textContent = `Showing ${totalCount} item${
        totalCount === 1 ? "" : "s"
      }`;
    }

    function wireMultiDropdowns() {
      const toggles = document.querySelectorAll(".multi-select");
      toggles.forEach((toggle) => {
        const filterName = toggle.getAttribute("data-filter-toggle");
        toggle.addEventListener("click", (e) => {
          e.stopPropagation();
          const isOpen = toggle.classList.contains("open");
          closeAllMultiMenus();
          if (!isOpen) {
            toggle.classList.add("open");
            const menu = document.querySelector(
              `.multi-select-menu[data-filter-menu="${filterName}"]`
            );
            if (menu) menu.classList.add("open");
          }
        });
      });

      document.querySelectorAll(".multi-select-menu").forEach((menu) => {
        menu.addEventListener("click", (e) => {
          e.stopPropagation();
        });
      });

      document.addEventListener("click", () => closeAllMultiMenus());
      document.addEventListener("keydown", (e) => {
        if (e.key === "Escape") closeAllMultiMenus();
      });
    }

    function closeAllMultiMenus() {
      document
        .querySelectorAll(".multi-select")
        .forEach((el) => el.classList.remove("open"));
      document
        .querySelectorAll(".multi-select-menu")
        .forEach((el) => el.classList.remove("open"));
    }

    function wireMultiCheckboxes() {
      document.querySelectorAll(".multi-select-menu").forEach((menu) => {
        const filterName = menu.getAttribute("data-filter-menu");
        menu.querySelectorAll('input[type="checkbox"]').forEach((cb) => {
          cb.addEventListener("change", () => {
            const val = cb.value;
            const set = multiState[filterName];
            if (!set) return;
            if (cb.checked) set.add(val);
            else set.delete(val);
            updateMultiLabel(filterName);
            currentPage = 1;
            applyFilters();
          });
        });

        const clearBtn = menu.querySelector(".multi-select-clear");
        if (clearBtn) {
          clearBtn.addEventListener("click", (e) => {
            e.stopPropagation();
            clearMultiSelect(filterName);
            currentPage = 1;
            applyFilters();
          });
        }
      });
    }

    function clearMultiSelect(filterName) {
      const set = multiState[filterName];
      if (!set) return;
      set.clear();

      const menu = document.querySelector(
        `.multi-select-menu[data-filter-menu="${filterName}"]`
      );
      if (menu) {
        menu.querySelectorAll('input[type="checkbox"]').forEach((cb) => {
          cb.checked = false;
        });
      }
      updateMultiLabel(filterName);
    }

    function clearAllMultiSelects() {
      Object.keys(multiState).forEach((key) => clearMultiSelect(key));
    }

    function restoreFilters() {
      try {
        const raw = localStorage.getItem(STORAGE_KEY);
        if (!raw) {
          currentPage = 1;
          applyFilters();
          return;
        }
        const state = JSON.parse(raw);

        searchInput.value = state.search || "";
        locationFilter.value = state.location || "";

        if (state.multi && typeof state.multi === "object") {
          Object.keys(multiState).forEach((filterName) => {
            const values = state.multi[filterName];
            if (!Array.isArray(values)) return;
            const set = new Set(values);
            multiState[filterName] = set;

            const menu = document.querySelector(
              `.multi-select-menu[data-filter-menu="${filterName}"]`
            );
            if (menu) {
              menu
                .querySelectorAll('input[type="checkbox"]')
                .forEach((cb) => {
                  cb.checked = set.has(cb.value);
                });
            }
            updateMultiLabel(filterName);
          });
        }

        hasPictureCheckbox.checked = !!state.hasPicture;
        currentPage = 1;
        applyFilters();
      } catch (e) {
        currentPage = 1;
        applyFilters();
      }
    }

    function debounce(fn, delay) {
      let t;
      return (...args) => {
        clearTimeout(t);
        t = setTimeout(() => fn(...args), delay);
      };
    }

    async function loadData() {
      try {
        resultsCount.textContent = "Loading inventory…";
        const res = await fetch(DATA_URL);
        if (!res.ok) throw new Error("HTTP " + res.status);
        const data = await res.json();

        if (!data || !Array.isArray(data.items)) {
          throw new Error("Unexpected response from server");
        }

        connectorData = data.items;

        // Pins (Stats!A2:A)
        if (Array.isArray(data.pinOptions)) {
          const pinsMenu = document.querySelector(
            '.multi-select-menu[data-filter-menu="pins"]'
          );
          const header = pinsMenu.querySelector(".multi-select-menu-header");
          pinsMenu.innerHTML = "";
          if (header) pinsMenu.appendChild(header);
          const pinsSorted = [...data.pinOptions].sort((a, b) => {
            const na = Number(a),
              nb = Number(b);
            if (!isNaN(na) && !isNaN(nb)) return na - nb;
            return String(a).localeCompare(String(b));
          });
          pinsSorted.forEach((val) => {
            if (!val) return;
            const label = document.createElement("label");
            const cb = document.createElement("input");
            cb.type = "checkbox";
            cb.value = val;
            label.appendChild(cb);
            label.appendChild(document.createTextNode(" " + val));
            pinsMenu.appendChild(label);
          });
        }

        // Supplier list (Stats!E2:E)
        if (Array.isArray(data.manufacturerOptions)) {
          const mMenu = document.querySelector(
            '.multi-select-menu[data-filter-menu="manufacturer"]'
          );
          const header = mMenu.querySelector(".multi-select-menu-header");
          mMenu.innerHTML = "";
          if (header) mMenu.appendChild(header);
          const mfrSorted = [...data.manufacturerOptions].sort((a, b) =>
            String(a).localeCompare(String(b))
          );
          mfrSorted.forEach((val) => {
            if (!val) return;
            const label = document.createElement("label");
            const cb = document.createElement("input");
            cb.type = "checkbox";
            cb.value = val;
            label.appendChild(cb);
            label.appendChild(document.createTextNode(" " + val));
            mMenu.appendChild(label);
          });
        }

        wireMultiCheckboxes();
        currentPage = 1;
        restoreFilters();
      } catch (err) {
        console.error(err);
        resultsBody.innerHTML = "";
        const row = document.createElement("tr");
        const cell = document.createElement("td");
        cell.colSpan = 12;
        cell.className = "muted";
        cell.textContent =
          "Error loading data: " + (err.message || "Unknown error");
        row.appendChild(cell);
        resultsBody.appendChild(row);
        resultsCount.textContent = "Error loading inventory";
      }
    }

    runActionBtn.addEventListener("click", () => {
      if (!selectedItem) {
        actionStatus.textContent = "Select a connector first.";
        return;
      }
      const action = actionSelect.value;
      if (!action) {
        actionStatus.textContent = "Choose an action.";
        return;
      }

      if (action === "request") {
        const params = new URLSearchParams({
          mode: "requestConnector",
          partNumber: selectedItem.partNumber || "",
          description: selectedItem.description || "",
          shop: selectedItem.shop || "",
          shopQty: String(selectedItem.shopQty ?? ""),
          van: selectedItem.van || "",
          vanQty: String(selectedItem.vanQty ?? ""),
          pins: String(selectedItem.pins ?? ""),
          category: selectedItem.category || "",
          manufacturer: selectedItem.manufacturer || "",
          passNumber: selectedItem.passNumber || "",
          source: "Connector Inventory Web",
        });

        params.append("ts", Date.now().toString());
        const url = REQUEST_URL + "?" + params.toString();

        let iframe = document.getElementById("requestFrame");
        if (!iframe) {
          iframe = document.createElement("iframe");
          iframe.id = "requestFrame";
          iframe.style.display = "none";
          document.body.appendChild(iframe);
        }

        iframe.src = url;
        actionStatus.textContent = "Request sent to Google Chat.";
      }
    });

    const debouncedApply = debounce(applyFilters, 250);
    searchInput.addEventListener("input", debouncedApply);
    locationFilter.addEventListener("input", () => {
      currentPage = 1;
      applyFilters();
    });
    hasPictureCheckbox.addEventListener("change", () => {
      currentPage = 1;
      applyFilters();
    });

    clearSearchBtn.addEventListener("click", () => {
      searchInput.value = "";
      searchInput.focus();
      currentPage = 1;
      applyFilters();
    });

    resetFiltersBtn.addEventListener("click", () => {
      searchInput.value = "";
      locationFilter.value = "";
      hasPictureCheckbox.checked = false;
      clearAllMultiSelects();
      currentPage = 1;
      applyFilters();
    });

    prevPageBtn.addEventListener("click", () => {
      if (currentPage > 1) {
        currentPage--;
        applyFilters();
      }
    });

    nextPageBtn.addEventListener("click", () => {
      if (currentPage < lastTotalPages) {
        currentPage++;
        applyFilters();
      }
    });

    document.querySelectorAll("th.sortable").forEach((th) => {
      th.addEventListener("click", () => {
        const key = th.dataset.sort;
        if (currentSort.key === key) {
          currentSort.dir = currentSort.dir === "asc" ? "desc" : "asc";
        } else {
          currentSort.key = key;
          currentSort.dir = "asc";
        }
        currentPage = 1;
        applyFilters();
      });
    });

    wireMultiDropdowns();
    loadData();
  </script>
</body>
</html>
